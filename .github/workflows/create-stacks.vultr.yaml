name: Create VPS instance using VultrCLI

on: 
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Log level'     
        required: false
        default: 'warning'

env:
  VULTR_VPS_REGION: syd
  VULTR_VPS_PLAN: vc2-1c-1gb
  VULTR_VPS_OS_IMAGE: 186 # CentOS
  VULTR_VPS_NAME: django-vue-stack
  VULTR_APP_ID: 17 # Docker
  SSH_EMAIL_ADDRESS: sammykerridge@gmail.com

jobs:
  ssh:
    name: Generate and store SSH keys
    runs-on: ubuntu-latest
    steps:
      - name: Generate new SSH key pair
        run: |
          ssh-keygen \
            -t ed25519 \
            -f ~/.ssh/id_ed25519 \
            -C "${{ env.SSH_EMAIL_ADDRESS }}" \
            -q -N ""

          PUBLIC_KEY="$(cat ~/.ssh/id_ed25519.pub)"
          PRIVATE_KEY="$(cat ~/.ssh/id_ed25519)"

          echo public: $PUBLIC_KEY

          # Mask values in logs
          echo "::add-mask::$PUBLIC_KEY"
          echo "::add-mask::$PRIVATE_KEY"
          
          # Set as environment variables
          echo "PUBLIC_KEY=$PUBLIC_KEY" >> $GITHUB_ENV
          echo 'PRIVATE_KEY<<EOF'  >> $GITHUB_ENV
          echo $PRIVATE_KEY >> $GITHUB_ENV
          echo 'EOF' >> $GITHUB_ENV

      - name: Add SSH public key to Github Secrets
        uses: gliech/create-github-secret-action@v1
        with:
          name: GH_SSH_PUBLIC_KEY
          value: ${{ env.PUBLIC_KEY }}
          pa_token: ${{ secrets.GH_PA_TOKEN }}

      - name: Add SSH private key to Github Secrets
        uses: gliech/create-github-secret-action@v1
        with:
          name: GH_SSH_PRIVATE_KEY
          value: ${{ env.PRIVATE_KEY }}
          pa_token: ${{ secrets.GH_PA_TOKEN }}

  vultr:
    name: Deploy Vultr VPS Instance
    needs: ssh
    runs-on: ubuntu-latest
    steps:
      - name: Install vultr-cli
        uses: techknowlogick/action-vultr@v2
        with:
          token: ${{ secrets.VULTR_API_KEY }}

      - name: Checkout start-script.sh startup script
        uses: Bhacaz/checkout-files@v1
        with:
          files: start-script.sh
          token: ${{ secrets.GH_ACTIONS_READ_ONLY }}

      - name: Find and replace secrets in start script
        uses: jacobtomlinson/gha-find-replace@master
        with:
          find: "<GH_ACCESS_TOKEN>"
          replace: "${{ secrets.GH_PA_TOKEN }}"
          include: "start-script.sh"

      - name: Find and replace secrets in start script
        uses: jacobtomlinson/gha-find-replace@master
        with:
          find: "<GH_SSH_URL>"
          replace: "${{ github.event.repository.ssh_url }}"
          include: "start-script.sh"

      - name: Find and replace secrets in start script
        uses: jacobtomlinson/gha-find-replace@master
        with:
          find: "<GH_USERNAME>"
          replace: "${{ github.repository_owner }}"
          include: "start-script.sh"

      - name: Find and replace secrets in start script
        uses: jacobtomlinson/gha-find-replace@master
        with:
          find: "<PUBLIC_KEY>"
          replace: "${{ secrets.GH_SSH_PUBLIC_KEY }}"
          include: "start-script.sh"

      - name: Push startup script using vultr-cli
        id: push-startup-script
        shell: bash
        run: |
          export VULTR_API_KEY=${{ secrets.VULTR_API_KEY }}
          vultr-cli script list

          # base64 encode our script
          SCRIPT=$(base64 -w0 start-script.sh)

          vultr-cli script create \
            --name ${{ env.VULTR_VPS_NAME }} \
            --type boot \
            --script $SCRIPT

          STARTUP_SCRIPT_ID=$(vultr-cli script list |  awk '/${{ env.VULTR_VPS_NAME }}/ { print $1 }')
          echo "::set-output name=STARTUP_SCRIPT_ID::$STARTUP_SCRIPT_ID"

      - name: Push SSH public key using vultr-cli
        id: push-ssh-key
        run: |
          export VULTR_API_KEY=${{ secrets.VULTR_API_KEY }}
          vultr-cli ssh-key list

          vultr-cli ssh-key create \
            --key "${{ secrets.GH_SSH_PUBLIC_KEY }}" \
            --name ${{ env.VULTR_VPS_NAME }}

          SSH_KEY_ID=$(vultr-cli ssh-key list |  awk '/${{ env.VULTR_VPS_NAME }}/ { print $1 }')
          echo "::set-output name=SSH_KEY_ID::$SSH_KEY_ID"
          
      - name: Get stuff by ID
        run: |
          export VULTR_API_KEY=${{ secrets.VULTR_API_KEY }}
          vultr-cli script get ${{ steps.push-startup-script.outputs.STARTUP_SCRIPT_ID }}
          vultr-cli ssh-key get ${{ steps.push-ssh-key.outputs.SSH_KEY_ID }}

      # - name: Create instance using vultr-cli
      #   id: create-new-instance
      #   run: |
      #     vultr-cli instance list
      #     vultr-cli instance create \
      #     --region ${{ env.VULTR_VPS_REGION }} \
      #     --plan ${{ env.VULTR_VPS_PLAN }} \
      #     --os ${{ env.VULTR_VPS_OS_IMAGE }} \
      #     --app ${{ env.VULTR_VPS_APP_ID }} \
      #     --label ${{ env.VULTR_VPS_NAME }} \
      #     --script-id ${{ steps.push-startup-script.outputs.STARTUP_SCRIPT_ID }}
      #     --ipv6 false
